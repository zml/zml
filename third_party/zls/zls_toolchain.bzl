"""Implementation of the zls_toolchain rule."""

load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

_VERSION = "0.16.0-dev.215+0e289f5c"

_ZLS_PLATFORMS = {
    "x86_64-linux": struct(
        compatible_with = [
            "@platforms//os:linux",
            "@platforms//cpu:x86_64",
        ],
    ),
    "x86_64-macos": struct(
        compatible_with = [
            "@platforms//os:macos",
            "@platforms//cpu:x86_64",
        ],
    ),
    "aarch64-macos": struct(
        compatible_with = [
            "@platforms//os:macos",
            "@platforms//cpu:aarch64",
        ],
    ),
}

_ZLS_VERSIONS = {
    "x86_64-linux": "27277ee215687fda4a80fa518fb38061f4abb56a469349853ac3e5671e005421",
    "x86_64-macos": "98e3618d41532fcb1b6148bed75f081fc2f42e74fa6a23827870eb328dfbf87c",
    "aarch64-macos": "fb711e068e2ec77b3979458ff72f18311fa7df74644a8cf43985c0f88cae5c66",
}

ZlsToolchainInfo = provider(
    doc = "Provide info for executing zls",
    fields = {
        "bin": "Executable ZLS binary",
    },
)

def _zls_toolchain_impl(ctx):
    binary = ctx.file.bin

    default_info = DefaultInfo(
        files = depset([binary]),
        runfiles = ctx.runfiles(files = [binary]),
    )
    zlstoolchaininfo = ZlsToolchainInfo(
        bin = binary,
    )
    toolchain_info = platform_common.ToolchainInfo(
        default = default_info,
        zlstoolchaininfo = zlstoolchaininfo,
    )

    return [
        default_info,
        zlstoolchaininfo,
        toolchain_info,
    ]

zls_toolchain = rule(
    implementation = _zls_toolchain_impl,
    attrs = {
        "bin": attr.label(
            executable = True,
            allow_single_file = True,
            cfg = "exec",
        ),
    },
)

def _zls_toolchains_repos_impl(mctx):
    for platform, _ in _ZLS_PLATFORMS.items():
        http_archive(
            name = "zls_{}".format(platform),
            url = "https://builds.zigtools.org/zls-{platform}-{version}.tar.xz".format(
                version = _VERSION,
                platform = platform,
            ),
            sha256 = _ZLS_VERSIONS[platform],
            build_file_content = """\
load("@@//third_party/zls:zls_toolchain.bzl", "zls_toolchain")
zls_toolchain(name = "toolchain", bin = "zls")
""",
        )

    zls_toolchains_repo(name = "zls_toolchains")

    return mctx.extension_metadata(
        reproducible = True,
        root_module_direct_deps = ["zls_toolchains"],
        root_module_direct_dev_deps = [],
    )

zls_toolchains = module_extension(
    implementation = _zls_toolchains_repos_impl,
)

def _zls_toolchains_repo_impl(rctx):
    build_content = """# @generated by @@//third_party/zls:zls_toolchain.bzl"""

    for platform, config in _ZLS_PLATFORMS.items():
        build_content += """
toolchain(
    name = "{platform}_toolchain",
    exec_compatible_with = {compatible_with},
    target_compatible_with = {compatible_with},
    toolchain = "@zls_{platform}//:toolchain",
    toolchain_type = "@@//third_party/zls:toolchain_type",
)
""".format(
            platform = platform,
            compatible_with = config.compatible_with,
        )

    rctx.file("BUILD.bazel", build_content)

zls_toolchains_repo = repository_rule(
    _zls_toolchains_repo_impl,
    doc = """Creates a repository with toolchain definitions for all known platforms
     which can be registered or selected.""",
)
